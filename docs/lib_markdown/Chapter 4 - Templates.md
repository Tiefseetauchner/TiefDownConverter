# Templates

Templating in TiefDown is done in several ways:

- [LaTeX templates](#latex-templates)
  - The most basic form of templating, it generates a LaTeX document from the
    markdown files that can be included in a LaTeX document.
  - Supports Metadata file generation.
- [Typst templates](#typst-templates)
  - Similar to LaTeX, it generates a Typst document from the markdown files
    that can be included in a Typst document.
  - Supports Metadata file generation.
- [EPUB templates](#epub-templates)
  - A legacy templating system, it generates a EPUB document from the markdown
    files. Convoluted and very much custom to basic usage.
  - Adds Metadata directly to the EPUB file.
  - (!) This template type should be forgone in favour of CustomPreprocessors
    conversion.
- [CustomPreprocessors conversion](#custompreprocessors-conversion)
  - A flexible pipeline where you define one or more preprocessors (Pandoc or
    any CLI) and write their combined output to a file your template or output
    references. No final processing step is performed.
  - Supports metadata insertion into CLI arguments.
- [CustomProcessor conversion](#customprocessor-conversion)
  - Preprocesses inputs to a single Pandoc Native document and then runs a
    final Pandoc call with your processor arguments to produce the artifact
    (e.g., HTML, docx, reveal.js, etc.).

## LaTeX Templates

LaTeX templates are the most intuitive form of templating in TiefDown, but also
the most fleshed out. The basic usage generates a LaTeX document from markdown,
usually output.tex, with [lua-filters](#lua-filters) applied depending on the
template, and then converts that template file to a PDF.

The LaTeX file must include the following:

```latex
\input{./output.tex}
```

This imports the converted markdown files into the LaTeX document. You may
adjust the behaviour by using [custom preprocessors](#custom-processors) and
[custom processors](#custom-processors).

For Metadata, one can also import the metadata file, which is generated by
TiefDown during the conversion process.

```latex
\input{./metadata.tex}
```

This file provides a macro to access metadata using the `\meta{}` keyword.
This can be adjusted using the [metadata settings](#metadata-settings).

There are preset templates available in the core library. These give a basic
framework for extension and shouldn't be taken as the only way to use LaTeX
templates.

## Typst Templates

Typst templates are, in concept, identical to LaTeX templates. They generate a
Typst document from markdown, usually output.typ, with [lua-filters](#lua-filters)
applied depending on the template, and then converts that template file to a PDF.

Importing the typst file works similar:

```typst
#include "output.typ"
```

Again, see [custom preprocessors](#custom-processors) and
[custom processors](#custom-processors) for more information on customization.

Metadata importing is easier as typst has an object system.

```typst
#import "./metadata.typ": meta
```

One can then access metadata using the `meta` object.

There are also preset templates available in the core library. Again, these
are just a basic suggestion.

## EPUB Templates

EPUB templates are a special version of custom preprocessing. They are
legacy and should be avoided in favour of CustomPreprocessors conversion. Thus,
they are not documented here.

## CustomPreprocessors Conversion

CustomPreprocessors replaces the older “Custom Pandoc Conversion” naming. It lets
you define exactly how inputs are preprocessed (with Pandoc or any CLI) and where
the combined output is written. There is no additional processing step after the
combined output is produced.

Key points

- Define one or more preprocessors under `[[custom_processors.preprocessors]]`.
- In the template, reference them via `preprocessors.preprocessors` and specify
  `preprocessors.combined_output`.
- The converter runs each preprocessor per extension group, captures stdout, and
  concatenates into the combined output file.
- Your template or output process must copy or reference this file to the final
  destination.

Example: single-file HTML without a LaTeX/Typst step

```toml
[[templates]]
name = "HTML Article"
template_type = "CustomPreprocessors"
output = "article.html"

  [templates.preprocessors]
  preprocessors = ["md-to-html"]
  combined_output = "output.html"

[[custom_processors.preprocessors]]
name = "md-to-html"
cli = "pandoc"
cli_args = ["-f", "gfm", "-t", "html"]
```

## CustomProcessor Conversion

CustomProcessor is a two-phase pipeline:

- Preprocess: Convert all inputs to Pandoc Native (defaults provided) and write
  a single `output.pandoc_native` file.
- Process: Run Pandoc once more, reading the native file and applying your
  processor’s arguments to produce the final artifact.

Requirements and behavior

- The template’s `processor` is required and must reference an entry under
  `[[custom_processors.processors]]`.
- `preprocessors.combined_output` should be a native file (defaults to
  `output.pandoc_native`).
- Lua filters configured on the template are applied to Pandoc preprocessing
  steps; the final Pandoc step uses `processor_args` only.

Example: produce a docx from the combined native document

```toml
[[templates]]
name = "Docx"
template_type = "CustomProcessor"
output = "book.docx"
processor = "docx"

  [templates.preprocessors]
  preprocessors = ["native"]
  combined_output = "output.pandoc_native"

[[custom_processors.preprocessors]]
name = "native"
cli = "pandoc"
cli_args = ["-t", "native"]

[[custom_processors.processors]]
name = "docx"
processor_args = ["--reference-doc", "resources/ref.docx"]
```
